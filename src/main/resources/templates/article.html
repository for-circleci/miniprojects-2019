<!DOCTYPE html>
<html layout:decorator="layout/default"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<th:block layout:fragment="head">
    <title>woostagram</title>
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/index.css">
</th:block>


<th:block layout:fragment="content">
    <div>
        <div class="page-container mrg-top-120">
            <div class="main-content">
                <div class="container-fluid max-width-lg mx-auto">
                    <div class="row">
                        <div class="col-lg-7 mx-auto">

                            <div class="card widget-feed no-pdd mrg-btm-70">
                                <div class="feed-header padding-15">
                                    <ul class="list-unstyled list-info">
                                        <li>
                                            <img class="thumb-img img-circle" src="/images/default/eastjun_profile.jpg"
                                                 alt="">
                                            <div class="info">
                                                <a href=""
                                                   class="title no-pdd-vertical text-bold inline-block font-size-15">eastjun</a>
                                            </div>
                                        </li>
                                        <a class="pointer absolute top-10 right-0" data-toggle="dropdown"
                                           aria-expanded="false">
                                        <span class="btn-icon text-dark">
                                            <i class="ti-more font-size-16"></i>
                                        </span>
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="pointer">
                                                    <i class="ti-trash pdd-right-10 text-dark"></i>
                                                    <span class="">게시글 삭제</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </ul>
                                </div>
                                <div class="feed-body no-pdd">
                                    <img id="article-image" class="img-fluid" src="" alt=""
                                         style="display: none; width: 100%;">
                                    <video id="article-video" controls autoplay loop src=""
                                           style="display: none; width: 100%;">
                                    </video>
                                </div>
                                <ul class="feed-action pdd-horizon-15 pdd-top-5">
                                    <li>
                                        <a href="">
                                            <i class="fa fa-heart activated-heart font-size-25"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="">
                                            <i class="ti-comment font-size-22"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="">
                                            <i class="ti-export font-size-22"></i>
                                        </a>
                                    </li>
                                    <li class="float-right">
                                        <a href="" class="pdd-right-0">
                                            <i class="fa fa-bookmark font-size-25"></i>
                                        </a>
                                    </li>
                                </ul>
                                <div class="feedback-status-container pdd-horizon-15">
                                    <img class="mini-profile-img" src="/images/default/eastjun_profile.jpg">
                                    <p class="no-mrg pdd-left-5 d-inline-block">
                                        <span class="text-bold">eastjun</span>님 외 <span class="text-bold">37</span>명이
                                        좋아합니다.
                                    </p>
                                </div>
                                <div class="feed-contents pdd-left-15">
                                    <p th:text="${article.contents}"></p>
                                </div>
                                <div class="feed-footer">
                                    <div class="comment">
                                        <ul class="list-unstyled list-info pdd-horizon-5">
                                            <li class="comment-item no-pdd">
                                                <div class="info pdd-left-15 pdd-vertical-5">
                                                    <a href=""
                                                       class="title no-pdd-vertical text-bold inline-block font-size-15">brown2</a>
                                                    <span class="font-size-14">안돌 어디갔다 온거였지?</span>
                                                    <time class="font-size-8 text-gray d-block">12시간 전</time>
                                                </div>
                                            </li>
                                        </ul>
                                        <div class="add-comment relative">
                                        <textarea rows="1" class="form-control text-dark padding-15"
                                                  placeholder="댓글 달기..."></textarea>
                                            <div class="absolute top-5 right-0">
                                                <button class="btn btn-default no-border text-gray">게시</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script th:inline="javascript">
    let articleId = [[${article.id}]];
    let articleFileName = [[${article.fileName}]]

    const b64StringToBlob = (b64Data, contentType = '', sliceSize = 512) => {
        const byteCharacters = atob(b64Data);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }
        const blob = new Blob(byteArrays, {type: contentType});
        return blob;
    };

    fetch('/articles/' + articleId + "/file", {
        method: "GET",
    }).then(response => {
        response.arrayBuffer().then(function (buffer) {
            var bytes = new Uint8Array(buffer);
            console.log('byte', bytes);

            var binary = '';
            bytes.forEach((b) => binary += String.fromCharCode(b));

            const blob = b64StringToBlob(binary);
            console.log('blob', blob);

            const blobUrl = URL.createObjectURL(blob);

            putSrc(blobUrl, articleFileName);
        });
    });

    function putSrc(url, fileName) {
        let words = fileName.split('.');
        let extension = words[words.length - 1];

        let imageExtensions = ['jpg', 'png', 'jpeg'];
        let videoExtensions = ['avi', 'mp4'];

        if (imageExtensions.includes(extension)) {
            let articleImage = document.getElementById('article-image');
            articleImage.style.display = "block";
            articleImage.src = url;
        }
        if (videoExtensions.includes(extension)) {
            let articleVideo = document.getElementById('article-video');
            articleVideo.style.display = "block";
            articleVideo.src = url;
        }
    }

</script>


</body>
</html>
